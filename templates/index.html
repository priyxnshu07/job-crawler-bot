<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Job Crawler</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/64d58efce2.js" crossorigin="anonymous"></script>
  <style>
    :root {
      --primary: #4481eb;
      --secondary: #04befe;
      --accent: #FFA500;
      --dark: #333;
      --light: #f0f2f5;
      --white: #fff;
      --gray: #acacac;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: var(--light); color: var(--dark); }

    .navbar {
      background: var(--white);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .user-menu { display: flex; align-items: center; gap: 15px; }
    .user-info { font-size: 0.9rem; font-weight: 500; }
    .logout-btn {
      padding: 8px 20px;
      border: 2px solid var(--primary);
      border-radius: 50px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      transition: 0.3s;
    }
    .logout-btn:hover { background: var(--primary); color: var(--white); }

    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 300px 1fr; gap: 2rem; }

    .sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
    .card { background: var(--white); padding: 1.5rem; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    
    .card h3 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--dark); display: flex; align-items: center; gap: 8px; }
    .card h3 i { color: var(--primary); }

    .skills-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .skill-tag { background: #e3f2fd; color: var(--primary); padding: 5px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 500; }
    .no-skills { font-size: 0.85rem; color: var(--gray); font-style: italic; }

    .upload-box {
      border: 2px dashed #cbd5e1;
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }
    .upload-box:hover { border-color: var(--primary); background: #f8faff; }
    .upload-box i { font-size: 2rem; color: var(--gray); margin-bottom: 10px; }
    .upload-box p { font-size: 0.85rem; color: var(--gray); }

    .btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 50px;
      background: var(--primary);
      color: var(--white);
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
    }
    .btn:hover { background: #3367d6; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    .btn-outline:hover { background: var(--primary); color: var(--white); }
    .btn-accent { background: var(--accent); }
    .btn-accent:hover { background: #e69500; }

    .main-content { display: flex; flex-direction: column; gap: 1.5rem; }
    
    .search-bar {
      display: flex;
      gap: 10px;
      background: var(--white);
      padding: 10px;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .search-bar input {
      flex: 1;
      border: none;
      outline: none;
      padding: 0 15px;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
    }
    .search-bar select {
      border: none;
      outline: none;
      background: #f0f2f5;
      padding: 0 15px;
      border-radius: 50px;
      color: var(--dark);
      font-family: 'Poppins', sans-serif;
    }
    .search-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: var(--white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: 0.3s;
    }
    .search-btn:hover { transform: scale(1.05); }

    .jobs-grid { display: grid; gap: 1.5rem; }
    .job-card {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.3s;
    }
    .job-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    
    .job-details h2 { font-size: 1.2rem; margin-bottom: 5px; color: var(--dark); }
    .job-details p { color: var(--gray); font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
    .job-details p i { color: var(--primary); font-size: 0.8rem; }
    
    .match-badge {
      background: #e0f2f1;
      color: #00695c;
      padding: 5px 12px;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 10px;
      display: inline-block;
    }
    .match-badge.high { background: #e8f5e9; color: #2e7d32; }
    .match-badge.med { background: #fff8e1; color: #f57f17; }
    
    .apply-btn {
      padding: 10px 25px;
      background: var(--primary);
      color: var(--white);
      text-decoration: none;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: 0.3s;
    }
    .apply-btn:hover { background: #3367d6; box-shadow: 0 5px 15px rgba(68, 129, 235, 0.3); }

    .debug-panel { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
    .debug-btn { padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }

    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
      .sidebar { order: 2; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="brand">
      <i class="fas fa-robot"></i> Job Crawler
    </div>
    <div class="user-menu">
      <div class="user-info">
        <i class="fas fa-user-circle"></i> {{ current_user.email }}
      </div>
      <a href="/logout" class="logout-btn">Logout</a>
    </div>
  </nav>

  <div class="container">
    <aside class="sidebar">
      <!-- Profile Card -->
      <div class="card">
        <h3><i class="fas fa-id-card"></i> Your Skills</h3>
        <div class="skills-container">
          {% if skills %}
            {% for skill in skills %}
              <span class="skill-tag">{{ skill }}</span>
            {% endfor %}
          {% else %}
            <span class="no-skills">No skills found. Upload your resume to get started.</span>
          {% endif %}
        </div>
      </div>

      <!-- Upload Card -->
      <div class="card">
        <h3><i class="fas fa-cloud-upload-alt"></i> Update Resume</h3>
        <form id="uploadForm" action="/upload_resume" method="POST" enctype="multipart/form-data">
          <div class="upload-box" id="uploadArea">
            <i class="fas fa-file-alt"></i>
            <p>Drag & drop or click to upload PDF/DOCX</p>
            <input type="file" name="resume" id="fileInput" accept=".pdf,.doc,.docx" style="display: none;" required>
          </div>
          <button type="submit" class="btn">Upload & Analyze</button>
        </form>
      </div>

      <!-- Settings Card -->
      <div class="card">
        <h3><i class="fas fa-cog"></i> Preferences</h3>
        <form action="/update-location" method="POST" style="margin-bottom: 15px;">
          <label style="font-size: 0.85rem; color: var(--gray);">Preferred Location</label>
          <input name="preferred_location" value="{{ preferred_location or '' }}" placeholder="e.g. Bangalore, Remote" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; outline: none;">
          <button type="submit" class="btn btn-outline" style="margin-top: 8px; padding: 5px;">Save Location</button>
        </form>
        
        <div style="border-top: 1px solid #eee; padding-top: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 0.9rem; font-weight: 500;">Email Alerts</span>
            <button id="toggleEmailAlerts" class="btn-accent" style="width: auto; padding: 5px 15px; font-size: 0.8rem;">
              {{ 'Disable' if current_user.email_alerts_enabled else 'Enable' }}
            </button>
          </div>
          
          <!-- Debug Tools -->
          <div class="debug-panel">
            <p style="font-size: 0.8rem; color: var(--gray); margin-bottom: 5px;">Debug Tools</p>
            <button id="testEmailBtn" class="btn btn-outline debug-btn">Test Email</button>
            <button id="testScrapeBtn" class="btn btn-outline debug-btn">Test Scraper</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search jobs by title, skill, or company...">
        <select id="locationFilter">
          <option value="">Any Location</option>
          <option value="Remote">Remote</option>
          <option value="Bangalore">Bangalore</option>
          <option value="Delhi">Delhi</option>
          <option value="Mumbai">Mumbai</option>
          <option value="Pune">Pune</option>
          <option value="Hyderabad">Hyderabad</option>
        </select>
        <button id="searchBtn" class="search-btn"><i class="fas fa-search"></i></button>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="font-size: 1.5rem; color: var(--dark);">Job Matches</h2>
        <button id="personalizedBtn" class="btn btn-accent" style="width: auto; padding: 8px 20px;">
          <i class="fas fa-magic"></i> Personalized for You
        </button>
      </div>

      <div id="jobListings" class="jobs-grid">
        <!-- Jobs will be inserted here -->
        <div style="text-align: center; padding: 40px; color: var(--gray);">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
          <p>Finding the best jobs for you...</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- Elements ---
    const searchInput = document.getElementById('searchInput');
    const locationFilter = document.getElementById('locationFilter');
    const searchBtn = document.getElementById('searchBtn');
    const personalizedBtn = document.getElementById('personalizedBtn');
    const jobListings = document.getElementById('jobListings');
    const toggleEmailAlertsBtn = document.getElementById('toggleEmailAlerts');
    const testEmailBtn = document.getElementById('testEmailBtn');
    const testScrapeBtn = document.getElementById('testScrapeBtn');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    let isPersonalized = true;

    // --- Job Fetching ---
    async function fetchJobs(query = '', personalized = false) {
      jobListings.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--gray);">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
          <p>Searching...</p>
        </div>`;

      try {
        const params = new URLSearchParams();
        if (personalized) params.set('personalized', 'true');
        if (query) params.set('q', query);
        if (locationFilter.value) params.set('location', locationFilter.value);

        const res = await fetch(`/search?${params.toString()}`);
        const jobs = await res.json();

        jobListings.innerHTML = '';

        if (!jobs || jobs.length === 0) {
          jobListings.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--gray);">
              <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i>
              <p>No jobs found. Try a different search or upload your resume.</p>
            </div>`;
          return;
        }

        jobs.forEach(job => {
          const score = job.match_score || 0;
          let matchClass = 'match-badge';
          if (score > 70) matchClass += ' high';
          else if (score > 40) matchClass += ' med';

          const html = `
            <div class="job-card">
              <div class="job-details">
                <h2>${job.title}</h2>
                <p><i class="fas fa-building"></i> ${job.company}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${job.location}</p>
                ${score > 0 ? `<span class="${matchClass}">${score}% Match</span>` : ''}
              </div>
              <a href="${job.apply_link}" target="_blank" class="apply-btn">Apply Now</a>
            </div>
          `;
          jobListings.insertAdjacentHTML('beforeend', html);
        });

      } catch (err) {
        console.error(err);
        jobListings.innerHTML = `<p style="color: red; text-align: center;">Error loading jobs.</p>`;
      }
    }

    // --- Event Listeners ---
    searchBtn.addEventListener('click', () => fetchJobs(searchInput.value, false));
    personalizedBtn.addEventListener('click', () => fetchJobs('', true));
    locationFilter.addEventListener('change', () => fetchJobs(searchInput.value, isPersonalized));
    
    // File Upload Drag & Drop
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
      uploadArea.style.background = '#f8faff';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = '#cbd5e1';
      uploadArea.style.background = 'transparent';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileInput.files = e.dataTransfer.files;
      document.getElementById('uploadForm').submit();
    });
    fileInput.addEventListener('change', () => document.getElementById('uploadForm').submit());

    // Email Alerts Toggle
    toggleEmailAlertsBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/toggle-email-alerts', { method: 'POST' });
        const data = await res.json();
        toggleEmailAlertsBtn.textContent = data.enabled ? 'Disable' : 'Enable';
        alert(data.enabled ? 'Email alerts enabled!' : 'Email alerts disabled.');
      } catch (err) {
        alert('Error toggling alerts');
      }
    });

    // --- Debug Buttons ---
    testEmailBtn.addEventListener('click', async () => {
      testEmailBtn.textContent = 'Sending...';
      try {
        const res = await fetch('/test-email');
        const data = await res.json();
        alert(data.message);
      } catch (err) {
        alert('Error sending test email');
      }
      testEmailBtn.textContent = 'Test Email';
    });

    testScrapeBtn.addEventListener('click', async () => {
      testScrapeBtn.textContent = 'Scraping...';
      try {
        const res = await fetch('/test-scrape');
        const data = await res.json();
        if(data.status === 'success') {
          alert(`Scrape complete! Found ${data.jobs_found} jobs for query "${data.query}". Refreshing list...`);
          fetchJobs('', true);
        } else {
          alert(`Scrape failed: ${data.message}`);
        }
      } catch (err) {
        alert('Error triggering scrape');
      }
      testScrapeBtn.textContent = 'Test Scraper';
    });

    // Initial Load
    fetchJobs('', true);
  </script>
</body>
</html>


