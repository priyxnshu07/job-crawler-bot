<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Crawler Bot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <nav class="navbar animate-fade-in">
    <div class="brand">
      <i class="fa-solid fa-robot"></i>
      <span>Job Crawler Bot</span>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="text-align: right; line-height: 1.2;">
        <div style="font-weight: 600;">{{ current_user.email }}</div>
        <div style="font-size: 0.8rem; color: var(--text-muted);">Member</div>
      </div>
      <a href="/logout" class="btn btn-outline" style="padding: 0.5rem 1rem;">Logout</a>
    </div>
  </nav>

  <div class="container animate-fade-in">
    <!-- Sidebar -->
    <aside style="display: flex; flex-direction: column; gap: 1.5rem;">

      <!-- Profile/Skills -->
      <div class="card">
        <div class="card-header">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
          Your Skills
        </div>
        <div class="skills-grid">
          {% if skills %}
          {% for skill in skills %}
          <span class="skill-tag">{{ skill }}</span>
          {% endfor %}
          {% else %}
          <p style="color: var(--text-muted); font-size: 0.9rem;">No skills found. Upload your resume to extract them
            automatically.</p>
          {% endif %}
        </div>
      </div>

      <!-- Upload Resume -->
      <div class="card">
        <div class="card-header">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          Update Resume
        </div>
        <form id="uploadForm" action="/upload_resume" method="POST" enctype="multipart/form-data">
          <div class="upload-zone" id="uploadArea">
            <i class="fa-regular fa-file-pdf upload-icon"></i>
            <p style="font-weight: 500;">Click or Drag Resume</p>
            <p style="font-size: 0.8rem; color: var(--text-muted);">PDF, DOC, DOCX</p>
            <input type="file" name="resume" id="fileInput" accept=".pdf,.doc,.docx" style="display: none;" required>
          </div>
        </form>
      </div>

      <!-- Settings -->
      <div class="card">
        <div class="card-header">
          <i class="fa-solid fa-sliders"></i>
          Preferences
        </div>

        <form action="/update-location" method="POST" class="form-group">
          <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Preferred
            Location</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" name="preferred_location" class="input-field" placeholder="e.g. Remote, Bangalore"
              value="{{ preferred_location or '' }}">
            <button type="submit" class="btn btn-primary" style="padding: 0.5rem;"><i
                class="fa-solid fa-check"></i></button>
          </div>
        </form>

        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 1.5rem 0;">

        <div class="card-header" style="font-size: 1rem;">
          <i class="fa-solid fa-envelope"></i>
          Email Alerts
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span style="font-size: 0.9rem;">Status</span>
          <button id="toggleEmailAlerts"
            class="btn btn-sm {{ 'btn-primary' if current_user.email_alerts_enabled else 'btn-ghost' }}"
            style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
            {{ 'Enabled' if current_user.email_alerts_enabled else 'Disabled' }}
          </button>
        </div>

        <!-- Email Config Form -->
        <form id="emailConfigForm"
          style="display: none; background: var(--secondary); padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">

          <div
            style="margin-bottom: 1rem; font-size: 0.8rem; color: var(--text-muted); background: #fff; padding: 0.75rem; border-radius: 6px; border-left: 3px solid var(--warning);">
            <strong><i class="fa-solid fa-circle-info"></i> How to get App Password:</strong>
            <ol style="margin-left: 1.2rem; margin-top: 0.5rem; margin-bottom: 0.5rem;">
              <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank"
                  style="color: var(--primary); text-decoration: underline;">Google App Passwords</a></li>
              <li>Select "Mail" and "Other (Custom name)"</li>
              <li>Name it "Job Crawler" and click Generate</li>
              <li>Copy the 16-digit code below</li>
            </ol>
          </div>
          <div class="form-group">
            <input type="text" id="smtpServer" class="input-field" placeholder="SMTP Server (e.g. smtp.gmail.com)"
              style="font-size: 0.8rem; padding: 0.5rem;">
          </div>
          <div class="form-group">
            <input type="text" id="smtpPort" class="input-field" placeholder="Port (e.g. 587)"
              style="font-size: 0.8rem; padding: 0.5rem;">
          </div>
          <div class="form-group">
            <input type="email" id="emailUser" class="input-field" placeholder="Your Email"
              style="font-size: 0.8rem; padding: 0.5rem;">
          </div>
          <div class="form-group">
            <input type="password" id="emailPass" class="input-field" placeholder="App Password"
              style="font-size: 0.8rem; padding: 0.5rem;">
          </div>
          <button type="button" id="saveEmailConfig" class="btn btn-primary"
            style="width: 100%; font-size: 0.8rem;">Save Config</button>
        </form>
        <button id="showEmailConfig" class="btn btn-ghost"
          style="width: 100%; font-size: 0.8rem; margin-top: 0.5rem;">Configure Email</button>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
          <button id="testEmailBtn" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.5rem;">Test
            Email</button>
          <button id="testScrapeBtn" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.5rem;">Test
            Scraper</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main>
      <div class="card animate-slide-in">
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
          <div style="position: relative; flex: 1;">
            <i class="fa-solid fa-magnifying-glass"
              style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
            <input type="text" id="searchInput" class="input-field" style="padding-left: 2.5rem;"
              placeholder="Search jobs by title, company, or keyword...">
          </div>
          <select id="locationFilter" class="input-field" style="width: auto;">
            <option value="">Any Location</option>
            <option value="Remote">Remote</option>
            <option value="Bangalore">Bangalore</option>
            <option value="Delhi">Delhi</option>
            <option value="Mumbai">Mumbai</option>
          </select>
          <button id="searchBtn" class="btn btn-primary">Search</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 style="font-size: 1.25rem; font-weight: 700;">Job Matches</h2>
          <button id="personalizedBtn" class="btn btn-ghost" style="color: var(--primary);">
            <i class="fa-solid fa-wand-magic-sparkles"></i> Personalized
          </button>
        </div>

        <div id="jobListings">
          <!-- Jobs will be loaded here -->
          <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Searching for the best jobs...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- Elements ---
    const searchInput = document.getElementById('searchInput');
    const locationFilter = document.getElementById('locationFilter');
    const searchBtn = document.getElementById('searchBtn');
    const personalizedBtn = document.getElementById('personalizedBtn');
    const jobListings = document.getElementById('jobListings');
    const toggleEmailAlertsBtn = document.getElementById('toggleEmailAlerts');
    const testEmailBtn = document.getElementById('testEmailBtn');
    const testScrapeBtn = document.getElementById('testScrapeBtn');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const showEmailConfig = document.getElementById('showEmailConfig');
    const emailConfigForm = document.getElementById('emailConfigForm');
    const saveEmailConfig = document.getElementById('saveEmailConfig');

    let isPersonalized = true;

    // --- Job Fetching ---
    async function fetchJobs(query = '', personalized = false) {
      jobListings.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Searching...</p>
                </div>`;

      try {
        const params = new URLSearchParams();
        if (personalized) params.set('personalized', 'true');
        if (query) params.set('q', query);
        if (locationFilter.value) params.set('location', locationFilter.value);

        const res = await fetch(`/search?${params.toString()}`);
        const jobs = await res.json();

        jobListings.innerHTML = '';

        if (!jobs || jobs.length === 0) {
          jobListings.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <i class="fa-solid fa-ghost" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No jobs found. Try a different search or upload your resume.</p>
                        </div>`;
          return;
        }

        jobs.forEach(job => {
          const score = job.match_score || 0;

          const html = `
                        <div class="job-card">
                            <div class="job-info">
                                <h3>${job.title}</h3>
                                <div class="job-meta">
                                    <span><i class="fa-solid fa-building"></i> ${job.company}</span>
                                    <span><i class="fa-solid fa-location-dot"></i> ${job.location}</span>
                                </div>
                                <div class="skills-grid">
                                    ${(job.matched_skills || []).slice(0, 5).map(s => `<span class="skill-tag" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;">${s}</span>`).join('')}
                                </div>
                            </div>
                            <div style="text-align: right; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                ${score > 0 ? `<span class="match-score">${score}% Match</span>` : ''}
                                <a href="${job.apply_link}" target="_blank" class="btn btn-primary" style="padding: 0.5rem 1.5rem; font-size: 0.85rem;">Apply</a>
                            </div>
                        </div>
                    `;
          jobListings.insertAdjacentHTML('beforeend', html);
        });

      } catch (err) {
        console.error(err);
        jobListings.innerHTML = `<p style="color: var(--danger); text-align: center;">Error loading jobs.</p>`;
      }
    }

    // --- Event Listeners ---
    searchBtn.addEventListener('click', () => fetchJobs(searchInput.value, false));
    personalizedBtn.addEventListener('click', () => fetchJobs('', true));
    locationFilter.addEventListener('change', () => fetchJobs(searchInput.value, isPersonalized));

    // File Upload
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
      uploadArea.style.background = '#eff6ff';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = '#cbd5e1';
      uploadArea.style.background = 'var(--secondary)';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileInput.files = e.dataTransfer.files;
      document.getElementById('uploadForm').submit();
    });
    fileInput.addEventListener('change', () => document.getElementById('uploadForm').submit());

    // Email Config
    showEmailConfig.addEventListener('click', () => {
      emailConfigForm.style.display = emailConfigForm.style.display === 'none' ? 'block' : 'none';
    });

    saveEmailConfig.addEventListener('click', async () => {
      const data = {
        smtp_server: document.getElementById('smtpServer').value,
        smtp_port: document.getElementById('smtpPort').value,
        email_username: document.getElementById('emailUser').value,
        email_password: document.getElementById('emailPass').value
      };

      try {
        const res = await fetch('/save-email-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(data)
        });
        if (res.ok) alert('Email settings saved!');
        else alert('Failed to save settings');
      } catch (e) { alert('Error saving settings'); }
    });

    // Toggle Alerts
    toggleEmailAlertsBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/toggle-email-alerts', { method: 'POST' });
        const data = await res.json();
        toggleEmailAlertsBtn.textContent = data.enabled ? 'Enabled' : 'Disabled';
        toggleEmailAlertsBtn.className = `btn btn-sm ${data.enabled ? 'btn-primary' : 'btn-ghost'}`;
      } catch (err) {
        alert('Error toggling alerts');
      }
    });

    // Debug Buttons
    testEmailBtn.addEventListener('click', async () => {
      testEmailBtn.textContent = 'Sending...';
      try {
        const res = await fetch('/test-email');
        const data = await res.json();
        alert(data.message);
      } catch (err) {
        alert('Error sending test email');
      }
      testEmailBtn.textContent = 'Test Email';
    });

    testScrapeBtn.addEventListener('click', async () => {
      testScrapeBtn.textContent = 'Scraping...';
      try {
        const res = await fetch('/test-scrape');
        const data = await res.json();
        if (data.status === 'success') {
          alert(`Scrape complete! Found ${data.jobs_found} jobs. Refreshing...`);
          fetchJobs('', true);
        } else {
          alert(`Scrape failed: ${data.message}`);
        }
      } catch (err) {
        alert('Error triggering scrape');
      }
      testScrapeBtn.textContent = 'Test Scraper';
    });

    // Initial Load
    fetchJobs('', true);
  </script>
</body>

</html>