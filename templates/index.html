<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Crawler Bot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <!-- Toast Container -->
  <div id="toast-container"
    style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px;">
  </div>
  <nav class="navbar animate-fade-in">
    <div class="brand">
      <i class="fa-solid fa-robot"></i>
      <span>Job Crawler Bot</span>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="text-align: right; line-height: 1.2;">
        <div style="font-weight: 600;">{{ current_user.email }}</div>
        <div style="font-size: 0.8rem; color: var(--text-muted);">Member</div>
      </div>
      <a href="/logout" class="btn btn-outline" style="padding: 0.5rem 1rem;">Logout</a>
    </div>
  </nav>

  <div class="container animate-fade-in">
    <!-- Sidebar -->
    <aside style="display: flex; flex-direction: column; gap: 1.5rem;">

      <!-- Profile/Skills -->
      <div class="card">
        <div class="card-header">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
          Your Skills
        </div>
        <div class="skills-grid">
          {% if skills %}
          {% for skill in skills %}
          <span class="skill-tag">{{ skill }}</span>
          {% endfor %}
          {% else %}
          <p style="color: var(--text-muted); font-size: 0.9rem;">No skills found. Upload your resume to extract them
            automatically.</p>
          {% endif %}
        </div>
      </div>

      <!-- Upload Resume -->
      <div class="card">
        <div class="card-header">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          Update Resume
        </div>
        <form id="uploadForm" action="/upload_resume" method="POST" enctype="multipart/form-data">
          <div class="upload-zone" id="uploadArea">
            <i class="fa-regular fa-file-pdf upload-icon"></i>
            <p style="font-weight: 500;">Click or Drag Resume</p>
            <p style="font-size: 0.8rem; color: var(--text-muted);">PDF, DOC, DOCX</p>
            <input type="file" name="resume" id="fileInput" accept=".pdf,.doc,.docx" style="display: none;" required>
          </div>
        </form>
      </div>

      <!-- Settings -->
      <div class="card">
        <div class="card-header">
          <i class="fa-solid fa-sliders"></i>
          Preferences
        </div>

        <form action="/update-location" method="POST" class="form-group">
          <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Preferred
            Location</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" name="preferred_location" class="input-field" placeholder="e.g. Remote, Bangalore"
              value="{{ preferred_location or '' }}">
            <button type="submit" class="btn btn-primary" style="padding: 0.5rem;"><i
                class="fa-solid fa-check"></i></button>
          </div>
        </form>

        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 1.5rem 0;">

        <div class="card-header" style="font-size: 1rem;">
          <i class="fa-solid fa-envelope"></i>
          Email Alerts
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span style="font-size: 0.9rem;">Status</span>
          <button id="toggleEmailAlerts"
            class="btn btn-sm {{ 'btn-primary' if current_user.email_alerts_enabled else 'btn-ghost' }}"
            style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
            {{ 'Enabled' if current_user.email_alerts_enabled else 'Disabled' }}
          </button>
        </div>

        <!-- Email Alerts Info (Admin-Managed) -->
        <div
          style="background: #f0f9ff; padding: 1rem; border-radius: 8px; border-left: 3px solid #007bff; margin-top: 1rem;">
          <h4 style="margin: 0 0 0.5rem 0; color: #007bff; font-size: 0.9rem;">ðŸ“§ Email Alerts</h4>
          <p style="margin: 0.5rem 0; font-size: 0.8rem; color: #666;">
            Get notified when new jobs match your skills! The site owner has configured email delivery.
          </p>
          <p style="margin: 0.5rem 0; font-size: 0.75rem; color: #888;">
            <i class="fa-solid fa-circle-info"></i> Emails sent from Job Scout Pro
          </p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
          <button id="testEmailBtn" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.5rem;">Test
            Email</button>
          <button id="testScrapeBtn" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.5rem;">Test
            Scraper</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main>
      <div class="card animate-slide-in">
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
          <div style="position: relative; flex: 1;">
            <i class="fa-solid fa-magnifying-glass"
              style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
            <input type="text" id="searchInput" class="input-field" style="padding-left: 2.5rem;"
              placeholder="Search jobs by title, company, or keyword...">
          </div>
          <select id="locationFilter" class="input-field" style="width: auto;">
            <option value="">Any Location</option>
            <option value="Remote">Remote</option>
            <option value="Bangalore">Bangalore</option>
            <option value="Delhi">Delhi</option>
            <option value="Mumbai">Mumbai</option>
          </select>
          <button id="searchBtn" class="btn btn-primary">Search</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 style="font-size: 1.25rem; font-weight: 700;">Job Matches</h2>
          <button id="personalizedBtn" class="btn btn-ghost" style="color: var(--primary);">
            <i class="fa-solid fa-wand-magic-sparkles"></i> Personalized
          </button>
        </div>

        <div id="jobListings">
          <!-- Jobs will be loaded here -->
          <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Searching for the best jobs...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- Elements ---
    const searchInput = document.getElementById('searchInput');
    const locationFilter = document.getElementById('locationFilter');
    const searchBtn = document.getElementById('searchBtn');
    const personalizedBtn = document.getElementById('personalizedBtn');
    const jobListings = document.getElementById('jobListings');
    const toggleEmailAlertsBtn = document.getElementById('toggleEmailAlerts');
    const testEmailBtn = document.getElementById('testEmailBtn');
    const testScrapeBtn = document.getElementById('testScrapeBtn');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const showEmailConfig = document.getElementById('showEmailConfig');
    const emailConfigForm = document.getElementById('emailConfigForm');
    const saveEmailConfig = document.getElementById('saveEmailConfig');

    // Dropdown Elements
    const smtpServerSelect = document.getElementById('smtpServerSelect');
    const smtpServerInput = document.getElementById('smtpServer');
    const smtpPortSelect = document.getElementById('smtpPortSelect');
    const smtpPortInput = document.getElementById('smtpPort');

    let isPersonalized = true;

    // --- Toast Notification System ---
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');

      // Colors based on type
      let bg = '#fff';
      let border = 'var(--primary)';
      let icon = 'fa-circle-info';

      if (type === 'success') { border = 'var(--success)'; icon = 'fa-check-circle'; }
      if (type === 'error') { border = 'var(--danger)'; icon = 'fa-circle-exclamation'; }
      if (type === 'warning') { border = 'var(--warning)'; icon = 'fa-triangle-exclamation'; }

      toast.style.cssText = `
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-left: 4px solid ${border};
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        font-size: 0.9rem;
        font-weight: 500;
      `;

      toast.innerHTML = `<i class="fa-solid ${icon}" style="color: ${border}; font-size: 1.1rem;"></i> <span>${message}</span>`;

      container.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.style.transform = 'translateX(0)';
      });

      // Remove after 3s
      setTimeout(() => {
        toast.style.transform = 'translateX(120%)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // --- Job Fetching ---
    async function fetchJobs(query = '', personalized = false) {
      jobListings.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Searching...</p>
                </div>`;

      try {
        const params = new URLSearchParams();
        if (personalized) params.set('personalized', 'true');
        if (query) params.set('q', query);
        if (locationFilter.value) params.set('location', locationFilter.value);

        const res = await fetch(`/search?${params.toString()}`);
        const jobs = await res.json();

        jobListings.innerHTML = '';

        if (!jobs || jobs.length === 0) {
          jobListings.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <i class="fa-solid fa-ghost" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No jobs found. Try a different search or upload your resume.</p>
                        </div>`;
          return;
        }

        jobs.forEach(job => {
          const score = job.match_score || 0;

          const html = `
                        <div class="job-card">
                            <div class="job-info">
                                <h3>${job.title}</h3>
                                <div class="job-meta">
                                    <span><i class="fa-solid fa-building"></i> ${job.company}</span>
                                    <span><i class="fa-solid fa-location-dot"></i> ${job.location}</span>
                                </div>
                                <div class="skills-grid">
                                    ${(job.matched_skills || []).slice(0, 5).map(s => `<span class="skill-tag" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;">${s}</span>`).join('')}
                                </div>
                            </div>
                            <div style="text-align: right; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                ${score > 0 ? `<span class="match-score">${score}% Match</span>` : ''}
                                <a href="${job.apply_link}" target="_blank" class="btn btn-primary" style="padding: 0.5rem 1.5rem; font-size: 0.85rem;">Apply</a>
                            </div>
                        </div>
                    `;
          jobListings.insertAdjacentHTML('beforeend', html);
        });

      } catch (err) {
        console.error(err);
        jobListings.innerHTML = `<p style="color: var(--danger); text-align: center;">Error loading jobs.</p>`;
        showToast('Failed to load jobs', 'error');
      }
    }

    // --- Event Listeners ---
    searchBtn.addEventListener('click', () => fetchJobs(searchInput.value, false));
    personalizedBtn.addEventListener('click', () => fetchJobs('', true));
    locationFilter.addEventListener('change', () => fetchJobs(searchInput.value, isPersonalized));

    // File Upload
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
      uploadArea.style.background = '#eff6ff';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = '#cbd5e1';
      uploadArea.style.background = 'var(--secondary)';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileInput.files = e.dataTransfer.files;
      document.getElementById('uploadForm').submit();
    });
    fileInput.addEventListener('change', () => document.getElementById('uploadForm').submit());

    // Email Config
    showEmailConfig.addEventListener('click', () => {
      emailConfigForm.style.display = emailConfigForm.style.display === 'none' ? 'block' : 'none';
    });

    // Email Config Dropdowns
    smtpServerSelect.addEventListener('change', () => {
      if (smtpServerSelect.value === 'custom') {
        smtpServerInput.style.display = 'block';
        smtpServerInput.value = '';
        smtpServerInput.focus();
      } else {
        smtpServerInput.style.display = 'none';
        smtpServerInput.value = smtpServerSelect.value;
      }
    });

    smtpPortSelect.addEventListener('change', () => {
      if (smtpPortSelect.value === 'custom') {
        smtpPortInput.style.display = 'block';
        smtpPortInput.value = '';
        smtpPortInput.focus();
      } else {
        smtpPortInput.style.display = 'none';
        smtpPortInput.value = smtpPortSelect.value;
      }
    });

    // Initialize inputs with dropdown values
    smtpServerInput.value = smtpServerSelect.value;
    smtpPortInput.value = smtpPortSelect.value;

    saveEmailConfig.addEventListener('click', async () => {
      const data = {
        sendgrid_api_key: document.getElementById('sendgridApiKey').value,
        from_email: document.getElementById('fromEmail').value
      };

      try {
        const res = await fetch('/save-email-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(data)
        });
        if (res.ok) showToast('Email settings saved successfully!', 'success');
        else showToast('Failed to save settings', 'error');
      } catch (e) { showToast('Error saving settings', 'error'); }
    });

    // Toggle Alerts
    toggleEmailAlertsBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/toggle-email-alerts', { method: 'POST' });
        const data = await res.json();
        toggleEmailAlertsBtn.textContent = data.enabled ? 'Enabled' : 'Disabled';
        toggleEmailAlertsBtn.className = `btn btn-sm ${data.enabled ? 'btn-primary' : 'btn-ghost'}`;
        showToast(`Email alerts ${data.enabled ? 'enabled' : 'disabled'}`, 'info');
      } catch (err) {
        showToast('Error toggling alerts', 'error');
      }
    });

    // Debug Buttons
    testEmailBtn.addEventListener('click', async () => {
      const originalText = testEmailBtn.textContent;
      testEmailBtn.textContent = 'Sending...';
      testEmailBtn.disabled = true;

      try {
        const res = await fetch('/test-email');
        const data = await res.json();

        if (data.status === 'success') {
          showToast(data.message, 'success');
        } else {
          showToast(data.message, 'error');
        }
      } catch (err) {
        showToast('Network error while sending email', 'error');
      }

      testEmailBtn.textContent = originalText;
      testEmailBtn.disabled = false;
    });

    testScrapeBtn.addEventListener('click', async () => {
      const originalText = testScrapeBtn.textContent;
      testScrapeBtn.textContent = 'Scraping...';
      testScrapeBtn.disabled = true;

      try {
        const res = await fetch('/test-scrape');
        const data = await res.json();
        if (data.status === 'success') {
          showToast(`Scrape complete! Found ${data.jobs_found} jobs.`, 'success');
          fetchJobs('', true);
        } else {
          showToast(`Scrape failed: ${data.message}`, 'error');
        }
      } catch (err) {
        showToast('Error triggering scrape', 'error');
      }

      testScrapeBtn.textContent = originalText;
      testScrapeBtn.disabled = false;
    });

    // Toggle Password Visibility
    // Toggle API Key Visibility
    const toggleApiKey = document.getElementById('toggleApiKey');
    const apiKeyInput = document.getElementById('sendgridApiKey');

    if (toggleApiKey && apiKeyInput) {
      toggleApiKey.addEventListener('click', function () {
        const type = apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
        apiKeyInput.setAttribute('type', type);
        const icon = this.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
      });
    }

    // Initial Load
    fetchJobs('', true);
  </script>
</body>

</html>